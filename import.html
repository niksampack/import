<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Bexio Data Import (Final Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body class="bg-gray-100 p-10 font-sans">

    <div class="max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-4 text-gray-700">Import Tool (Smart Fix)</h1>
        
        <div class="mb-6 p-4 border rounded bg-blue-50 border-blue-200">
            <h3 class="font-bold text-blue-800 mb-2">Schritt 1: Verbindung</h3>
            <button id="testBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Verbindung Testen
            </button>
            <span id="testResult" class="ml-3 font-bold"></span>
        </div>

        <div class="mb-6 p-4 border rounded bg-gray-50 border-gray-200" id="step2">
            <h3 class="font-bold text-gray-800 mb-2">Schritt 2: Datei hochladen</h3>
            <input type="file" id="csvFile" accept=".csv" class="block w-full mb-4"/>
            <button id="uploadBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded disabled:opacity-50" disabled>
                Start Upload
            </button>
        </div>

        <div class="mt-6">
            <label class="font-bold text-sm">Status & Protokoll:</label>
            <div id="logArea" class="w-full h-64 p-4 border rounded bg-black text-green-400 font-mono text-xs overflow-y-auto whitespace-pre-wrap">Bereit...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, writeBatch, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCY9TmJwzoJRWFTAjhDFBD0eFMR4YKTHJQ",
            authDomain: "listapp-96713.firebaseapp.com",
            projectId: "listapp-96713",
            storageBucket: "listapp-96713.firebasestorage.app",
            messagingSenderId: "1044312662356",
            appId: "1:1044312662356:web:64fd48530c4238127828c1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        function log(msg, type="info") {
            const area = document.getElementById('logArea');
            const color = type === "error" ? "text-red-400" : (type === "warn" ? "text-yellow-400" : "text-green-400");
            area.innerHTML += `<div class="${color}">> ${msg}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        // 1. TEST CONNECTION
        document.getElementById('testBtn').addEventListener('click', async () => {
            log("Teste Verbindung...", "warn");
            try {
                await setDoc(doc(db, "bexio_contacts", "_connection_test"), { test: true, time: new Date() });
                log("✅ Verbindung erfolgreich!");
                document.getElementById('testResult').innerText = "✅ OK";
                document.getElementById('testResult').className = "ml-3 font-bold text-green-600";
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('step2').classList.remove('opacity-50');
            } catch (error) {
                log("❌ Fehler: " + error.message, "error");
            }
        });

        // 2. UPLOAD
        document.getElementById('uploadBtn').addEventListener('click', () => {
            const file = document.getElementById('csvFile').files[0];
            if (!file) return log("❌ Bitte Datei wählen!", "error");

            log(`Lese Datei: ${file.name}...`, "warn");
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                encoding: "UTF-8",
                delimiter: "", // Auto-detect delimiter (Important!)
                complete: async function(results) {
                    if (results.data && results.data.length > 0) {
                        const firstRow = results.data[0];
                        const columns = Object.keys(firstRow);
                        log(`Datei gelesen. ${results.data.length} Zeilen gefunden.`);
                        log(`Gefundene Spalten: [ ${columns.join(' | ')} ]`, "warn");
                        
                        await uploadToFirebase(results.data);
                    } else {
                        log("❌ Datei scheint leer zu sein oder Format falsch.", "error");
                    }
                },
                error: (err) => log("CSV Fehler: " + err.message, "error")
            });
        });

        function getValue(item, keys) {
            const lowerKeys = keys.map(k => k.toLowerCase());
            for (let key in item) {
                if (lowerKeys.includes(key.toLowerCase())) return item[key] ? item[key].trim() : "";
            }
            return "";
        }

        async function uploadToFirebase(data) {
            log("Starte Upload in Datenbank...", "warn");
            let batch = writeBatch(db);
            let batchCount = 0;
            let successCount = 0;
            const total = data.length;

            for (let i = 0; i < total; i++) {
                const item = data[i];
                
                // Fields mapping
                const name = getValue(item, ["name", "name_1", "firma", "company", "Name", "Firmenname"]);
                const restaurant = getValue(item, ["restaurant", "name_2", "Zusatz"]);
                const phone = getValue(item, ["mobil", "mobile", "telefon", "tel", "phone", "festnetz", "Telefon", "Mobil"]);
                
                // Address construction
                let fullAddress = getValue(item, ["address", "adresse", "Adresse"]);
                if (!fullAddress || fullAddress.length < 5) {
                    const street = getValue(item, ["strasse", "street", "Strasse"]);
                    const num = getValue(item, ["nummer", "nr", "Nr"]);
                    const zip = getValue(item, ["plz", "zip", "PLZ"]);
                    const city = getValue(item, ["stadt", "ort", "city", "Ort"]);
                    if(street || city) fullAddress = `${street} ${num}, ${zip} ${city}`.trim();
                }

                if (!name) continue; // Skip if no name

                const docData = {
                    name: name,
                    restaurant: restaurant,
                    address: fullAddress || "",
                    phone: phone || "",
                    source: "bexio_import"
                };

                const ref = doc(collection(db, "bexio_contacts"));
                batch.set(ref, docData);
                batchCount++;
                successCount++;

                if (batchCount >= 400) {
                    await batch.commit();
                    batch = writeBatch(db);
                    batchCount = 0;
                    log(`... ${i} von ${total} gespeichert.`);
                }
            }

            if (batchCount > 0) await batch.commit();

            if (successCount === 0) {
                log("⚠️ ACHTUNG: 0 Kontakte gespeichert!", "error");
                log("Grund: Das Programm hat die Spalten 'name' oder 'firma' nicht gefunden.", "error");
                log("Bitte prüfen Sie die Spaltennamen oben im Protokoll.", "error");
            } else {
                log(`✅ FERTIG! ${successCount} Kontakte erfolgreich importiert.`, "green");
                log("Sie können das Fenster jetzt schließen und die App neu laden.");
            }
        }
    </script>
</body>
</html>
