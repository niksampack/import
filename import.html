<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Bexio Data Import (Smart)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body class="bg-gray-100 p-10">

    <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-4 text-gray-700">Import Bexio Contacts</h1>
        
        <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 text-blue-700 text-sm">
            <p class="font-bold">Info:</p>
            <p>Das System erkennt automatisch getrennte Adressfelder (Strasse, Nr, PLZ, Stadt) und kombiniert sie.</p>
        </div>

        <input type="file" id="csvFile" accept=".csv" class="block w-full mb-4 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>

        <button id="uploadBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded disabled:opacity-50">
            Start Upload
        </button>

        <div id="statusArea" class="mt-6 hidden">
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="statusText" class="text-center text-sm text-gray-600">Bereit...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, writeBatch, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCY9TmJwzoJRWFTAjhDFBD0eFMR4YKTHJQ",
            authDomain: "listapp-96713.firebaseapp.com",
            projectId: "listapp-96713",
            storageBucket: "listapp-96713.firebasestorage.app",
            messagingSenderId: "1044312662356",
            appId: "1:1044312662356:web:64fd48530c4238127828c1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.getElementById('uploadBtn').addEventListener('click', () => {
            const file = document.getElementById('csvFile').files[0];
            if (!file) return alert("Bitte CSV wählen.");

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: async function(results) {
                    await uploadToFirebase(results.data);
                }
            });
        });

        // Helper to find value regardless of case (e.g., "Strasse" or "strasse")
        function getValue(item, keys) {
            const lowerKeys = keys.map(k => k.toLowerCase());
            for (let key in item) {
                if (lowerKeys.includes(key.toLowerCase())) {
                    return item[key] ? item[key].trim() : "";
                }
            }
            return "";
        }

        async function uploadToFirebase(data) {
            const statusArea = document.getElementById('statusArea');
            const statusText = document.getElementById('statusText');
            statusArea.classList.remove('hidden');

            let batch = writeBatch(db);
            let batchCount = 0;
            let total = data.length;

            for (let i = 0; i < total; i++) {
                const item = data[i];

                // 1. Get Name & Phone & Restaurant
                // Note: Bexio usually puts company name in "name_1" or "Name"
                const name = getValue(item, ["name", "name_1", "firma", "company"]);
                const restaurant = getValue(item, ["restaurant", "name_2"]); // Usually restaurant name is second line
                const phone = getValue(item, ["phone", "telefon", "tel", "mobile"]);

                // 2. Build Full Address Smartly
                let fullAddress = getValue(item, ["address", "adresse"]); // If already combined
                
                if (!fullAddress || fullAddress.length < 5) {
                    const street = getValue(item, ["strasse", "street", "address_street"]);
                    const num = getValue(item, ["nummer", "nr", "house_number"]);
                    const zip = getValue(item, ["plz", "zip", "postal cod", "postal_code"]);
                    const city = getValue(item, ["stadt", "ort", "city", "address_city"]);
                    
                    // Combine: "Bahnhofstrasse 10, 8000 Zürich"
                    fullAddress = `${street} ${num}, ${zip} ${city}`.trim();
                    // Cleanup trailing commas if data is missing
                    if(fullAddress === ",") fullAddress = "";
                }

                if (!name) continue; // Skip empty rows

                const docData = {
                    name: name,
                    restaurant: restaurant,
                    address: fullAddress,
                    phone: phone,
                    source: "bexio"
                };

                const ref = doc(collection(db, "bexio_contacts"));
                batch.set(ref, docData);
                batchCount++;

                if (batchCount >= 400) {
                    await batch.commit();
                    batch = writeBatch(db);
                    batchCount = 0;
                    document.getElementById('progressBar').style.width = Math.round((i / total) * 100) + "%";
                }
            }

            if (batchCount > 0) await batch.commit();

            document.getElementById('progressBar').style.width = "100%";
            statusText.innerText = "Fertig! Daten importiert.";
            alert("✅ Import erfolgreich!");
        }
    </script>
</body>
</html>