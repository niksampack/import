<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Tool (Smart Version)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 p-10 font-sans">

    <div class="max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“¦ Produkte Importieren (Smart Fix)</h1>
        
        <div class="mb-6 p-8 border-2 border-dashed border-indigo-300 rounded-lg bg-indigo-50 text-center cursor-pointer hover:bg-indigo-100 transition" onclick="document.getElementById('fileInput').click()">
            <span class="text-4xl">ğŸ“‚</span>
            <p class="mt-2 font-bold text-indigo-700">Excel-Datei hier auswÃ¤hlen (.xlsx)</p>
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleFileSelect()">
        </div>

        <button id="uploadBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded shadow-md disabled:opacity-50 transition" onclick="processFile()" disabled>
            Start Import
        </button>

        <div class="mt-6">
            <div id="status" class="font-bold text-gray-600 mb-2">Warte auf Datei...</div>
            <div id="logArea" class="w-full h-64 p-4 border rounded bg-gray-900 text-green-400 font-mono text-xs overflow-y-auto"></div>
        </div>
    </div>

    <script type="module">
        // --------------------------------------------------------------
        // ğŸ”´ Ú©Ø¯ ÙØ§ÛŒØ±Ø¨ÛŒØ³ (Ù‡Ù…Ø§Ù† Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø´Ù…Ø§Ø³Øª)
        // --------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCY9TmJwzoJRWFTAjhDFBD0eFMR4YKTHJQ",
            authDomain: "listapp-96713.firebaseapp.com",
            projectId: "listapp-96713",
            storageBucket: "listapp-96713.firebasestorage.app",
            messagingSenderId: "1044312662356",
            appId: "1:1044312662356:web:64fd48530c4238127828c1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --------------------------------------------------------------
        // ğŸ§  Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø³ØªÙˆÙ†â€ŒÙ‡Ø§
        // --------------------------------------------------------------
        
        // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯ Ø¨Ø¨ÛŒÙ†Ø¯ Ú©Ø¯Ø§Ù… Ø§Ø³Ù… Ø³ØªÙˆÙ† Ø¯Ø± ÙØ§ÛŒÙ„ Ø´Ù…Ø§ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
        function findValue(row, possibleNames) {
            // ØªØ¨Ø¯ÛŒÙ„ ØªÙ…Ø§Ù… Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø¨Ù‡ Ø­Ø±ÙˆÙ Ú©ÙˆÚ†Ú© Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡
            const rowKeys = Object.keys(row).map(k => k.toLowerCase().trim());
            const rowEntries = Object.entries(row);

            for (let name of possibleNames) {
                const search = name.toLowerCase();
                // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù…Ù‚Ø¯Ø§Ø± ÙˆØ§Ù‚Ø¹ÛŒ
                const foundEntry = rowEntries.find(([key, val]) => key.toLowerCase().trim() === search);
                if (foundEntry) return foundEntry[1];
            }
            return null;
        }

        window.handleFileSelect = function() {
            const input = document.getElementById('fileInput');
            const btn = document.getElementById('uploadBtn');
            if (input.files.length > 0) {
                btn.disabled = false;
                document.getElementById('status').innerText = "âœ… Datei bereit: " + input.files[0].name;
            }
        }

        function log(msg, color="text-green-400") {
            const area = document.getElementById('logArea');
            area.innerHTML += `<div class="${color} border-b border-gray-800 py-1">> ${msg}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        window.processFile = async function() {
            const fileInput = document.getElementById('fileInput');
            const btn = document.getElementById('uploadBtn');
            const status = document.getElementById('status');
            
            btn.disabled = true;
            status.innerText = "â³ Analysiere Excel-Datei...";
            
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheetName]);

                    if (jsonData.length === 0) throw new Error("Datei ist leer!");

                    // ğŸ” Ú†Ø§Ù¾ Ù†Ø§Ù… Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
                    const foundColumns = Object.keys(jsonData[0]);
                    log(`Gefundene Spalten: [ ${foundColumns.join(' | ')} ]`, "text-yellow-300");

                    let batch = writeBatch(db);
                    let count = 0;
                    let successCount = 0;

                    for (const row of jsonData) {
                        // Ù„ÛŒØ³Øª ØªÙ…Ø§Ù… Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù…Ú©Ù† Ø¨Ø±Ø§ÛŒ Ù†Ø§Ù… Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ (Ø¢Ù„Ù…Ø§Ù†ÛŒ Ùˆ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)
                        const code = findValue(row, ['Produktcode', 'Code', 'Nr', 'Artikelnummer', 'Nummer', 'ID', 'No']);
                        const name = findValue(row, ['Produktname', 'Name', 'Bezeichnung', 'Beschreibung', 'Artikelname', 'Text']);
                        const cat = findValue(row, ['Hauptgruppe', 'Kategorie', 'Gruppe', 'Warengruppe', 'Category']);
                        const price = findValue(row, ['Verkaufspreis', 'Preis', 'Price', 'VP', 'Betrag']);
                        const unit = findValue(row, ['Einheit', 'Unit', 'Menge', 'Basis']);

                        if (!code) continue; // Ø§Ú¯Ø± Ú©Ø¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø±Ø¯ Ø´Ùˆ

                        const productData = {
                            code: String(code).trim(),
                            name: name || 'Unbekannt',
                            category: cat || 'General',
                            unit: unit || 'Stk',
                            price: Number(price) || 0,
                            updatedAt: new Date()
                        };

                        const docRef = doc(db, "products", String(code).trim());
                        batch.set(docRef, productData);

                        count++;
                        successCount++;
                        log(`+ ${productData.name} (${productData.category})`);

                        if (count >= 400) {
                            await batch.commit();
                            batch = writeBatch(db);
                            count = 0;
                            log(`--- Zwischenspeichern... ---`, "text-blue-300");
                        }
                    }

                    if (count > 0) await batch.commit();

                    status.innerText = "ğŸ‰ Import Fertig!";
                    status.classList.add("text-green-600");
                    alert(`Erfolg! ${successCount} Produkte importiert.`);
                    log(`âœ… ${successCount} Produkte erfolgreich gespeichert.`, "text-green-200 font-bold");

                } catch (error) {
                    console.error(error);
                    status.innerText = "âŒ Fehler";
                    log(`FEHLER: ${error.message}`, "text-red-500");
                    alert("Ø®Ø·Ø§: Ù„Ø·ÙØ§Ù‹ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø¯Ø±Ø³Øª Ø§Ø³Øª.");
                    btn.disabled = false;
                }
            };
            reader.readAsArrayBuffer(file);
        };
    </script>
</body>
</html>
